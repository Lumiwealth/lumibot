# Timeshift Bug Fix Verification - Four-Pass Protocol

**Date:** October 17, 2025, 7:00 PM EST (STARTING)
**Test Window:** July 15-26, 2024 (SHORT window for faster iteration)
**Protocol Used:** THETADATA_TESTING_PROTOCOL.md (manual, supervised, documented)
**Run ID:** `TIMESHIFT_FIX_OCT17_2025`

---

## üéØ OBJECTIVES

### Primary Goal
Verify that the two timeshift bug fixes produce pandas-polars parity:

1. **thetadata_helper.py:414-426** - Removed aggressive dt filtering that cut off future bars
2. **polars_data.py:671-683** - Fixed timedelta conversion in aggregation cache path

### Success Criteria
- ‚úÖ Both implementations return 2 rows for timeshift=-2 (unit test confirmed)
- ‚è≥ Pandas warm: network_requests = 0
- ‚è≥ Polars warm #1: network_requests = 0
- ‚è≥ Polars warm #2: network_requests = 0
- ‚è≥ Pandas warm trades CSV == Polars warm #2 trades CSV (exact match)
- ‚è≥ Log evidence shows `[LOOK_AHEAD_BIAS!]` with `timeshift=-2` as integer

---

## üìã TEST SETUP

**Backtest Parameters:**
- Date range: July 15 - July 26, 2024 (12 days)
- Strategy: Weekly Momentum Options
- Test script: `tests/performance/profile_weekly_momentum.py`
- Cache location: `/Users/robertgrzesik/Library/Caches/lumibot/1.0/thetadata/`

**Test Sequence:**
1. ‚è≥ Clear cache ONCE at start
2. ‚è≥ Pandas Cold (populate cache) - supervised, live tail
3. ‚è≥ Polars Warm #1 (consume cache) - supervised, live tail
4. ‚è≥ Polars Warm #2 (consume cache) - supervised, live tail
5. ‚è≥ Pandas Warm (consume cache) - supervised, live tail
6. ‚è≥ Diff trade CSVs (pandas_warm vs polars_warm2)
7. ‚è≥ Verify log evidence (timeshift type, LOOK_AHEAD_BIAS markers)

---

## üîß CODE FIXES BEING VERIFIED

### Fix #1: ThetaData Helper - dt Filtering Bug
**File:** `lumibot/tools/thetadata_helper.py:414-426`

**Problem:** Helper was filtering cached data by current broker time (dt), cutting off future bars needed for negative timeshift (intentional look-ahead for fill simulation).

**Fix:** Removed dt filtering; now returns full `[start, end]` range from cache. Look-ahead bias protection happens at `get_bars()` level, not cache retrieval.

**Evidence Location:** Search logs for `[NO_DT_FILTER]` and `[LOOK_AHEAD_BIAS!]`

### Fix #2: Polars Data - Timedelta Conversion Bug
**File:** `lumibot/data_sources/polars_data.py:671-683`

**Problem:** Code assumed integer timeshift was in minutes when converting to timedelta. `timeshift=-2` became `timedelta(minutes=-2)` = `"-1 day, 23:58:00"`.

**Fix:** Integer timeshift now represents BAR offsets. Calculate adjustment based on actual timestep:
```python
timestep_delta, _ = self.convert_timestep_str_to_timedelta(timestep)
now = now + (timestep_delta * timeshift)
```

**Evidence Location:** Search logs for `[TIMESHIFT_DEBUG]` showing `timeshift_type=int timeshift_value=-2`

---

## üìä TEST EXECUTION LOG

### Run #0: Clear Cache
**Command:**
```bash
rm -rf ~/Library/Caches/lumibot/1.0/thetadata && \
mkdir -p ~/Library/Caches/lumibot/1.0/thetadata && \
echo "Cache cleared at $(date)"
```

**Status:** üèÉ READY TO RUN
**Timestamp:** Will be captured from command output
**Result:** Will verify directory is empty

---

### Run #1: Pandas Cold
**Command:**
```bash
cd ~/Documents/Development/lumivest_bot_server/strategies/lumibot
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
echo "=== PANDAS COLD TEST ==="
echo "Start time: $(date)"
echo "Log file: logs/parity_pandas_cold_${TIMESTAMP}.log"
time python tests/performance/profile_weekly_momentum.py --mode pandas \
  2>&1 | tee logs/parity_pandas_cold_${TIMESTAMP}.log
echo "End time: $(date)"
```

**Status:** üèÉ READY TO RUN
**PID:** Will be captured during execution
**Start time:** Will be captured from command output
**End time:** Will be captured from command output
**Duration:** Will be captured from `time` command
**Log file:** `logs/parity_pandas_cold_YYYYMMDD_HHMMSS.log`
**Trade CSV:** Will be auto-generated by script (look for `WeeklyMomentumOptionsStrategy_*_trades.csv`)
**Network requests:** Will grep for `network_requests=` in log
**Cache files created:** Will list `/Users/robertgrzesik/Library/Caches/lumibot/1.0/thetadata/*.parquet`

**Key Log Evidence to Capture:**
```bash
# Look for timeshift handling
grep "\[TIMESHIFT" logs/parity_pandas_cold_*.log

# Look for LOOK_AHEAD_BIAS markers
grep "LOOK_AHEAD_BIAS" logs/parity_pandas_cold_*.log

# Look for dt filtering behavior
grep "\[NO_DT_FILTER\]" logs/parity_pandas_cold_*.log
```

---

### Run #2: Polars Warm #1
**Command:**
```bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
python tests/performance/profile_weekly_momentum.py --mode polars \
  > logs/parity_polars_warm1_${TIMESTAMP}.log 2>&1
```

**Status:** ‚è≥ PENDING
**PID:**
**Start time:**
**End time:**
**Duration:**
**Log file:** `logs/parity_polars_warm1_YYYYMMDD_HHMMSS.log`
**Trade CSV:** (auto-generated by script)
**Network requests:** (MUST be 0)
**Cache files used:** (from pandas cold)

**Key Log Evidence to Capture:**
```bash
# Verify network requests = 0
grep "network_requests=" logs/parity_polars_warm1_*.log

# Verify timeshift type preservation
grep "\[TIMESHIFT_DEBUG\]" logs/parity_polars_warm1_*.log | head -5

# Verify LOOK_AHEAD_BIAS detection
grep "LOOK_AHEAD_BIAS" logs/parity_polars_warm1_*.log
```

---

### Run #3: Pandas Warm
**Command:**
```bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
python tests/performance/profile_weekly_momentum.py --mode pandas \
  > logs/parity_pandas_warm_${TIMESTAMP}.log 2>&1
```

**Status:** ‚è≥ PENDING
**PID:**
**Start time:**
**End time:**
**Duration:**
**Log file:** `logs/parity_pandas_warm_YYYYMMDD_HHMMSS.log`
**Trade CSV:** (auto-generated by script)
**Network requests:** (MUST be 0)
**Cache files used:** (reused)

---

### Run #4: Polars Warm #2
**Command:**
```bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
python tests/performance/profile_weekly_momentum.py --mode polars \
  > logs/parity_polars_warm2_${TIMESTAMP}.log 2>&1
```

**Status:** ‚è≥ PENDING
**PID:**
**Start time:**
**End time:**
**Duration:**
**Log file:** `logs/parity_polars_warm2_YYYYMMDD_HHMMSS.log`
**Trade CSV:** (auto-generated by script)
**Network requests:** (MUST be 0)
**Cache files used:** (reused)

---

## üîç VERIFICATION STEPS

### Step 1: Diff Trade CSVs
**Command:**
```bash
# Find the trade CSV files (auto-generated by script with timestamps)
PANDAS_WARM_CSV=$(ls -t logs/*pandas*warm*trades.csv | head -1)
POLARS_WARM2_CSV=$(ls -t logs/*polars*warm2*trades.csv | head -1)

# Diff them
diff -u $PANDAS_WARM_CSV $POLARS_WARM2_CSV
echo "Exit code: $?"
```

**Expected Result:** Exit code 0 (no differences)
**Actual Result:** ‚è≥ PENDING

**CSV Diff Output:**
```
[Will paste diff output here]
```

---

### Step 2: Verify Timeshift Type Preservation
**Command:**
```bash
# Check polars logs for timeshift type
grep "\[TIMESHIFT_DEBUG\].*timeshift_type=int.*timeshift_value=-2" logs/parity_polars_warm*.log
```

**Expected Result:** Should find log entries showing `timeshift_type=int` and `timeshift_value=-2`
**Actual Result:** ‚è≥ PENDING

**Log Evidence:**
```
[Will paste log snippets here]
```

---

### Step 3: Verify LOOK_AHEAD_BIAS Detection
**Command:**
```bash
# Both should show LOOK_AHEAD_BIAS detection
grep "future_bars=.*LOOK_AHEAD_BIAS" logs/parity_pandas*.log | head -5
grep "future_bars=.*LOOK_AHEAD_BIAS" logs/parity_polars*.log | head -5
```

**Expected Result:** Both implementations detect future bars (intentional for fill simulation)
**Actual Result:** ‚è≥ PENDING

**Log Evidence:**
```
[Will paste log snippets here]
```

---

### Step 4: Verify Network Requests
**Command:**
```bash
# All warm runs should show 0 network requests
grep "network_requests=" logs/parity_*warm*.log
```

**Expected Result:**
```
parity_polars_warm1_*.log: network_requests=0
parity_pandas_warm_*.log: network_requests=0
parity_polars_warm2_*.log: network_requests=0
```

**Actual Result:** ‚è≥ PENDING

---

## üìà RESULTS SUMMARY

### Metrics Table
| Test | Network Requests | Time (sec) | Trade Count | Log File |
|------|-----------------|------------|-------------|----------|
| **Pandas Cold** | ‚è≥ | ‚è≥ | ‚è≥ | ‚è≥ |
| **Polars Warm #1** | ‚è≥ (expect 0) | ‚è≥ | ‚è≥ | ‚è≥ |
| **Pandas Warm** | ‚è≥ (expect 0) | ‚è≥ | ‚è≥ | ‚è≥ |
| **Polars Warm #2** | ‚è≥ (expect 0) | ‚è≥ | ‚è≥ | ‚è≥ |

### Trade Parity
- **Pandas Warm trades:** ‚è≥
- **Polars Warm #2 trades:** ‚è≥
- **CSV diff result:** ‚è≥ (expect: identical)

### Evidence Checklist
- [ ] Timeshift stays as integer (-2), not converted to timedelta
- [ ] Both implementations show `[LOOK_AHEAD_BIAS!]` markers
- [ ] Both implementations show `[NO_DT_FILTER]` in helper logs
- [ ] All warm runs have network_requests=0
- [ ] Trade CSVs are identical (diff exit code 0)

---

## ‚úÖ SUCCESS / ‚ùå FAILURE

**Status:** ‚è≥ IN PROGRESS

**Outcome:**

**Issues Found:**

**Next Steps:**

---

## üìÇ LOG FILES

All logs stored in `logs/` directory with timestamps:
- `logs/parity_pandas_cold_YYYYMMDD_HHMMSS.log`
- `logs/parity_polars_warm1_YYYYMMDD_HHMMSS.log`
- `logs/parity_pandas_warm_YYYYMMDD_HHMMSS.log`
- `logs/parity_polars_warm2_YYYYMMDD_HHMMSS.log`

Trade CSVs auto-generated by strategy with timestamps.

---

**Last Updated:** October 17, 2025, 7:00 PM EST
